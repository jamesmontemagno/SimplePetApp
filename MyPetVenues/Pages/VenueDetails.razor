@page "/venue/{Id:int}"
@using MyPetVenues.Models
@using MyPetVenues.Services
@using MyPetVenues.Components
@inject IVenueService VenueService
@inject NavigationManager Navigation

<PageTitle>@(venue?.Name ?? "Venue Details") - MyPetVenues</PageTitle>

<div class="venue-details-page">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="loading-spinner">üêæ</div>
            <p>Loading venue details...</p>
        </div>
    }
    else if (venue == null)
    {
        <div class="error-state">
            <div class="error-icon">‚ùå</div>
            <h2>Venue Not Found</h2>
            <p>The venue you're looking for doesn't exist or has been removed.</p>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/venues")'>
                Browse All Venues
            </button>
        </div>
    }
    else
    {
        <!-- Venue Header -->
        <div class="venue-header">
            <button class="btn-back" @onclick='() => Navigation.NavigateTo("/venues")'>
                ‚Üê Back to Venues
            </button>
            <div class="venue-hero">
                <img src="@venue.ImageUrl" alt="@venue.Name" class="venue-hero-image" />
                <div class="venue-hero-overlay">
                    <div class="venue-category-badge">@GetCategoryEmoji(venue.Category) @venue.Category</div>
                </div>
            </div>
        </div>

        <!-- Venue Info -->
        <div class="venue-content">
            <div class="venue-main">
                <h1 class="venue-title">@venue.Name</h1>
                
                <div class="venue-meta">
                    <div class="venue-rating-large">
                        <RatingStars Rating="@venue.AverageRating" ShowNumber="true" />
                        <span class="review-count">(@venue.Reviews.Count reviews)</span>
                    </div>
                    <div class="venue-location">
                        <span class="location-icon">üìç</span>
                        <span>@venue.Location</span>
                    </div>
                </div>

                <div class="venue-description">
                    <h2 class="section-heading">About This Venue</h2>
                    <p>@venue.Description</p>
                </div>

                <!-- Pet Types -->
                <div class="venue-pets">
                    <h3 class="subsection-heading">üêæ Pets Welcome</h3>
                    <div class="pet-badges">
                        @foreach (var petType in venue.PetTypesAllowed)
                        {
                            <div class="pet-badge-large">
                                <span class="pet-badge-icon">@GetPetEmoji(petType)</span>
                                <span class="pet-badge-name">@petType</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Amenities -->
                @if (venue.Amenities.Count > 0)
                {
                    <div class="venue-amenities">
                        <h3 class="subsection-heading">‚ú® Amenities</h3>
                        <div class="amenities-grid">
                            @foreach (var amenity in venue.Amenities)
                            {
                                <div class="amenity-item">
                                    <span class="amenity-icon">@GetAmenityEmoji(amenity)</span>
                                    <span class="amenity-name">@FormatAmenityName(amenity)</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Reviews Section -->
                <div class="venue-reviews">
                    <div class="reviews-header">
                        <h2 class="section-heading">üìù Reviews (@venue.Reviews.Count)</h2>
                        <button class="btn btn-primary" @onclick="ShowAddReviewForm">
                            Write a Review
                        </button>
                    </div>

                    @if (showAddReview)
                    {
                        <div class="add-review-form">
                            <h3>Share Your Experience</h3>
                            <div class="form-group">
                                <label>Your Name</label>
                                <input type="text" class="form-control" @bind="newReview.ReviewerName" placeholder="Enter your name" />
                            </div>
                            <div class="form-group">
                                <label>Rating</label>
                                <select class="form-control" @bind="newReview.Rating">
                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
                                    <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
                                    <option value="2">‚≠ê‚≠ê Poor</option>
                                    <option value="1">‚≠ê Terrible</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Your Review</label>
                                <textarea class="form-control" rows="4" @bind="newReview.Comment" placeholder="Tell us about your experience..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" @onclick="SubmitReview">Submit Review</button>
                                <button class="btn btn-secondary" @onclick="CancelReview">Cancel</button>
                            </div>
                        </div>
                    }

                    @if (venue.Reviews.Count == 0)
                    {
                        <div class="no-reviews">
                            <p>No reviews yet. Be the first to review this venue!</p>
                        </div>
                    }
                    else
                    {
                        <div class="reviews-list">
                            @foreach (var review in venue.Reviews.OrderByDescending(r => r.ReviewDate))
                            {
                                <ReviewCard Review="@review" />
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Sidebar -->
            <div class="venue-sidebar">
                <div class="contact-card">
                    <h3 class="card-title">üìû Contact Information</h3>
                    @if (!string.IsNullOrEmpty(venue.Phone))
                    {
                        <div class="contact-item">
                            <span class="contact-icon">üì±</span>
                            <a href="tel:@venue.Phone">@venue.Phone</a>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(venue.Website))
                    {
                        <div class="contact-item">
                            <span class="contact-icon">üåê</span>
                            <a href="@venue.Website" target="_blank" rel="noopener">Visit Website</a>
                        </div>
                    }
                    <div class="contact-item">
                        <span class="contact-icon">üìç</span>
                        <span>@venue.Location</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Venue? venue;
    private bool isLoading = true;
    private bool showAddReview = false;
    private Review newReview = new() { Rating = 5 };

    protected override async Task OnInitializedAsync()
    {
        await LoadVenue();
    }

    private async Task LoadVenue()
    {
        isLoading = true;
        venue = await VenueService.GetVenueByIdAsync(Id);
        isLoading = false;
    }

    private void ShowAddReviewForm()
    {
        showAddReview = true;
        newReview = new Review { Rating = 5 };
    }

    private void CancelReview()
    {
        showAddReview = false;
        newReview = new Review { Rating = 5 };
    }

    private async Task SubmitReview()
    {
        if (string.IsNullOrWhiteSpace(newReview.ReviewerName) || string.IsNullOrWhiteSpace(newReview.Comment))
        {
            return;
        }

        await VenueService.AddReviewAsync(Id, newReview);
        await LoadVenue();
        showAddReview = false;
        newReview = new Review { Rating = 5 };
    }

    private string GetCategoryEmoji(VenueCategory category)
    {
        return category switch
        {
            VenueCategory.Cafe => "‚òï",
            VenueCategory.Restaurant => "üçΩÔ∏è",
            VenueCategory.Park => "üå≥",
            VenueCategory.Hotel => "üè®",
            VenueCategory.Store => "üõçÔ∏è",
            VenueCategory.Veterinary => "üè•",
            VenueCategory.Grooming => "‚úÇÔ∏è",
            VenueCategory.Home => "üè†",
            _ => "üìç"
        };
    }

    private string GetPetEmoji(PetType petType)
    {
        return petType switch
        {
            PetType.Dogs => "üêï",
            PetType.Cats => "üêà",
            PetType.Rabbits => "üê∞",
            PetType.Birds => "ü¶ú",
            PetType.Reptiles => "ü¶é",
            PetType.SmallAnimals => "üêπ",
            _ => "üêæ"
        };
    }

    private string GetAmenityEmoji(Amenity amenity)
    {
        return amenity switch
        {
            Amenity.WaterBowls => "üíß",
            Amenity.OutdoorSeating => "ü™ë",
            Amenity.PetMenu => "üçñ",
            Amenity.Treats => "ü¶¥",
            Amenity.OffLeashArea => "üèÉ",
            Amenity.WasteBags => "üóëÔ∏è",
            Amenity.Parking => "üÖøÔ∏è",
            Amenity.Indoor => "üè†",
            Amenity.Outdoor => "üå§Ô∏è",
            Amenity.Shade => "‚õ±Ô∏è",
            Amenity.PetWashStation => "üöø",
            _ => "‚úì"
        };
    }

    private string FormatAmenityName(Amenity amenity)
    {
        return amenity switch
        {
            Amenity.WaterBowls => "Water Bowls",
            Amenity.OutdoorSeating => "Outdoor Seating",
            Amenity.PetMenu => "Pet Menu",
            Amenity.Treats => "Treats Available",
            Amenity.OffLeashArea => "Off-Leash Area",
            Amenity.WasteBags => "Waste Bags",
            Amenity.Parking => "Parking",
            Amenity.Indoor => "Indoor Space",
            Amenity.Outdoor => "Outdoor Space",
            Amenity.Shade => "Shaded Areas",
            Amenity.PetWashStation => "Pet Wash Station",
            _ => amenity.ToString()
        };
    }
}
